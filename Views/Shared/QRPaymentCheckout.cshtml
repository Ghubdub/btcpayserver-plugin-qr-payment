@using BTCPayServer.Plugins.QRPayment
@model BTCPayServer.Models.InvoicingModels.PaymentModel
@{
    var qrPaymentData = Model.AdditionalData.GetValueOrDefault("QRPayment", null);
}

@if (qrPaymentData != null && qrPaymentData.Enabled == true)
{
    <div class="payment-method" data-id="QRPayment">
        <div class="qr-payment-container">
            <div class="qr-payment-header">
                <h3>@qrPaymentData.Title</h3>
                <p>@qrPaymentData.Content</p>
            </div>
            
            <div class="qr-payment-qrcode">
                <img src="@qrPaymentData.QRCodeImage" 
                     alt="QR Code for @qrPaymentData.Title" 
                     class="qr-image" />
            </div>
            
            <div class="qr-payment-details">
                <div class="detail-row">
                    <span class="label">Invoice:</span>
                    <span class="value">@qrPaymentData.InvoiceId.Substring(0, 8)...</span>
                </div>
                <div class="detail-row">
                    <span class="label">Amount:</span>
                    <span class="value amount">@qrPaymentData.Amount @qrPaymentData.Currency</span>
                </div>
            </div>
            
            <div class="qr-payment-actions">
                <button type="button" 
                        class="btn btn-primary btn-lg btn-block mark-paid-btn"
                        data-invoice-id="@qrPaymentData.InvoiceId">
                    <i class="fa fa-check-circle"></i> Mark as Paid
                </button>
            </div>
            
            <div class="qr-payment-status" id="qr-payment-status-@qrPaymentData.InvoiceId">
                <div class="status-pending">
                    <i class="fa fa-clock-o"></i> Waiting for payment...
                </div>
            </div>
        </div>
    </div>
    
    <script>
    (function() {
        var invoiceId = '@qrPaymentData.InvoiceId';
        var statusDiv = document.getElementById('qr-payment-status-' + invoiceId);
        var markPaidBtn = document.querySelector('.mark-paid-btn[data-invoice-id="' + invoiceId + '"]');
        
        if (markPaidBtn && statusDiv) {
            markPaidBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (confirm('Are you sure you want to mark this invoice as paid?')) {
                    markPaidBtn.disabled = true;
                    markPaidBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Processing...';
                    
                    fetch('/api/v1/plugins/qr-payment/invoices/' + invoiceId + '/mark-paid', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'token ' + (window.btcpay && window.btcpay.token || '')
                        },
                        body: JSON.stringify({
                            notes: 'Manually marked as paid via QR Payment plugin'
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(data) {
                        if (data.error) {
                            alert('Error: ' + data.error);
                            markPaidBtn.disabled = false;
                            markPaidBtn.innerHTML = '<i class="fa fa-check-circle"></i> Mark as Paid';
                        } else {
                            statusDiv.innerHTML = '<div class="status-paid"><i class="fa fa-check-circle"></i> Payment confirmed on ' + new Date(data.paidAt).toLocaleString() + '</div>';
                            markPaidBtn.style.display = 'none';
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        alert('An error occurred while marking as paid. Please try again.');
                        markPaidBtn.disabled = false;
                        markPaidBtn.innerHTML = '<i class="fa fa-check-circle"></i> Mark as Paid';
                    });
                }
            });
        }
    })();
    </script>
}
